<nav-bar title="è®¢å•è¯¦æƒ…" left-arrow="{{true}}" />

<view class="page-container">
  <block wx:if="{{!loading && order}}">
    <!-- Status card -->
    <view class="status-card" style="background: {{statusBg}};">
      <text class="status-title" style="color: {{statusColor}};">{{statusTitle}}</text>
      <text class="status-desc">{{statusDesc}}</text>
      <!-- è‡ªå–è®¢å•ï¼šREADYæ—¶ç»™ç”¨æˆ·çœ‹å–é¤ç  -->
      <view wx:if="{{order.status === 'READY' && order.pickup_code && order.delivery_type !== 'delivery'}}" class="pickup-code-block">
        <text class="pickup-code-hint">å–é¤ç </text>
        <text class="pickup-code-value">{{order.pickup_code}}</text>
      </view>
      <!-- é…é€è®¢å•ï¼šæ˜¾ç¤ºéª‘æ‰‹ä¿¡æ¯ -->
      <view wx:if="{{order.delivery_type === 'delivery' && order.status === 'DELIVERING' && order.rider_name}}" class="rider-info-block">
        <text class="rider-info-hint">é…é€éª‘æ‰‹</text>
        <text class="rider-info-value">{{order.rider_name}}</text>
      </view>
    </view>

    <!-- é…é€åœ°å€ï¼ˆé…é€è®¢å•ï¼‰ -->
    <view wx:if="{{order.delivery_type === 'delivery' && order.delivery_address}}" class="section-card">
      <view class="section-title">é…é€åœ°å€</view>
      <view class="delivery-address-row">
        <view class="delivery-addr-contact">
          <text class="delivery-addr-name">{{order.delivery_address.name}}</text>
          <text class="delivery-addr-phone">{{order.delivery_address.phone}}</text>
        </view>
        <text class="delivery-addr-detail">{{order.delivery_address.address}}{{order.delivery_address.detail ? ' ' + order.delivery_address.detail : ''}}</text>
      </view>
    </view>

    <!-- Merchant info -->
    <view class="section-card merchant-row" bindtap="onGoShop">
      <view class="merchant-info">
        <text class="merchant-icon">ğŸª</text>
        <text class="merchant-name">{{order.merchant_name}}</text>
      </view>
      <text class="merchant-arrow">></text>
    </view>

    <!-- Product details -->
    <view class="section-card">
      <view class="section-title">å•†å“ä¿¡æ¯</view>
      <view class="product-row" wx:for="{{orderItems}}" wx:key="product_id">
        <view class="product-info">
          <text class="product-name">{{item.name}}</text>
          <text class="product-spec" wx:if="{{item.specText}}"> ({{item.specText}})</text>
        </view>
        <view class="product-right">
          <text class="product-qty">x{{item.quantity}}</text>
          <view class="product-price">
            <price value="{{item.subtotal}}" />
          </view>
        </view>
      </view>

      <view class="price-divider"></view>

      <view class="price-row">
        <text class="price-label">å•†å“åˆè®¡</text>
        <view class="price-value"><price value="{{order.total_price}}" /></view>
      </view>
      <view class="price-row">
        <text class="price-label">åŒ…è£…è´¹</text>
        <view class="price-value"><price value="{{order.packing_fee}}" /></view>
      </view>
      <view class="price-row">
        <text class="price-label">é…é€è´¹</text>
        <view class="price-value"><price value="{{order.delivery_fee}}" /></view>
      </view>

      <view class="price-divider"></view>

      <view class="price-row price-row--total">
        <text class="price-label">å®ä»˜é‡‘é¢</text>
        <view class="price-value price-value--total"><price value="{{order.actual_price}}" /></view>
      </view>
    </view>

    <!-- Order meta -->
    <view class="section-card">
      <view class="section-title">è®¢å•ä¿¡æ¯</view>
      <view class="meta-row">
        <text class="meta-label">è®¢å•ç¼–å·</text>
        <view class="meta-value-wrap">
          <text class="meta-value">{{order.order_no}}</text>
          <text class="meta-copy" bindtap="onCopyOrderNo">å¤åˆ¶</text>
        </view>
      </view>
      <view class="meta-row">
        <text class="meta-label">ä¸‹å•æ—¶é—´</text>
        <text class="meta-value">{{createTimeStr}}</text>
      </view>
      <view class="meta-row">
        <text class="meta-label">æ”¯ä»˜æ–¹å¼</text>
        <text class="meta-value">å¾®ä¿¡æ”¯ä»˜</text>
      </view>
      <view class="meta-row" wx:if="{{order.remark}}">
        <text class="meta-label">å¤‡æ³¨</text>
        <text class="meta-value">{{order.remark}}</text>
      </view>
      <view class="meta-row" wx:if="{{order.cancel_reason}}">
        <text class="meta-label">å–æ¶ˆåŸå› </text>
        <text class="meta-value">{{order.cancel_reason}}</text>
      </view>
    </view>
  </block>

  <view wx:elif="{{loading}}" class="loading-center">
    <text>åŠ è½½ä¸­...</text>
  </view>
</view>

<!-- Bottom action bar -->
<view class="action-bar" wx:if="{{buttons.length}}">
  <view
    wx:for="{{buttons}}"
    wx:key="type"
    class="action-btn action-btn--{{item.style}}"
    data-type="{{item.type}}"
    bindtap="onActionTap"
  >
    {{item.text}}
  </view>
</view>

<!-- é€€æ¬¾åŸå› å¼¹çª— -->
<view wx:if="{{showRefundModal}}" class="refund-mask" bindtap="onRefundCancel">
  <view class="refund-popup" catchtap="" catchtouchmove="noop">
    <view class="refund-title">ç”³è¯·é€€æ¬¾</view>
    <view class="refund-hint">å‡ºé¤åå°†æ— æ³•é€€æ¬¾ï¼Œè¯·ç¡®è®¤</view>
    <textarea
      class="refund-textarea"
      placeholder="è¯·å¡«å†™é€€æ¬¾åŸå› ï¼ˆå¿…å¡«ï¼‰"
      value="{{refundReason}}"
      adjust-position="{{false}}"
      bindinput="onRefundReasonInput"
      maxlength="200"
      auto-height
    />
    <view class="refund-actions">
      <button class="refund-btn refund-btn--cancel" bindtap="onRefundCancel">å–æ¶ˆ</button>
      <button class="refund-btn refund-btn--confirm" bindtap="onRefundConfirm">ç¡®è®¤é€€æ¬¾</button>
    </view>
  </view>
</view>

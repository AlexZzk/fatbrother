<nav-bar left-arrow="{{true}}" bgColor="transparent" />

<view class="page-container">
  <block wx:if="{{!loading && merchant}}">
    <!-- å•†å®¶å¤´å›¾ -->
    <view class="shop-header">
      <image
        class="shop-banner-img"
        src="{{merchant.shop_banner || '/images/default-banner.png'}}"
        mode="aspectFill"
      />
      <view class="shop-header-mask"></view>
    </view>

    <!-- å•†å®¶ä¿¡æ¯ -->
    <view class="shop-info-card">
      <image class="shop-avatar" src="{{merchant.shop_avatar || '/images/default-shop.png'}}" mode="aspectFill" />
      <view class="shop-detail">
        <text class="shop-name">{{merchant.shop_name}}</text>
        <view class="shop-meta">
          <text class="shop-rating">{{merchant.rating || '5.0'}}</text>
          <text class="shop-sales">æœˆå”®{{merchant.monthly_sales || 0}}å•</text>
        </view>
      </view>
    </view>

    <!-- å…¬å‘Š -->
    <view wx:if="{{merchant.announcement}}" class="shop-announcement">
      <text>ğŸ“¢ {{merchant.announcement}}</text>
    </view>

    <!-- èœå•åŒºåŸŸï¼šå·¦ä¾§åˆ†ç±» + å³ä¾§å•†å“ -->
    <view class="menu-area">
      <!-- å·¦ä¾§åˆ†ç±» -->
      <scroll-view class="category-nav" scroll-y>
        <view
          wx:for="{{menu}}"
          wx:key="_id"
          class="category-tab {{activeCategoryIndex === index ? 'category-tab--active' : ''}}"
          data-index="{{index}}"
          bindtap="onCategoryTap"
        >
          {{item.name}}
        </view>
      </scroll-view>

      <!-- å³ä¾§å•†å“åˆ—è¡¨ -->
      <scroll-view class="product-list" scroll-y scroll-into-view="cat-{{activeCategoryIndex}}">
        <view wx:for="{{menu}}" wx:key="_id" id="cat-{{index}}">
          <view class="product-category-title">{{item.name}}</view>
          <product-item
            wx:for="{{item.products}}"
            wx:for-item="product"
            wx:key="_id"
            product="{{product}}"
            count="{{productCounts[product._id] || 0}}"
            bind:add="onAddProduct"
            bind:minus="onMinusProduct"
            bind:specadd="onSpecAdd"
          />
        </view>
      </scroll-view>
    </view>
  </block>

  <view wx:elif="{{loading}}" class="loading-center">
    <text>åŠ è½½ä¸­...</text>
  </view>
</view>

<!-- è§„æ ¼å¼¹çª— -->
<spec-popup
  show="{{showSpecPopup}}"
  product="{{specProduct}}"
  bind:confirm="onSpecConfirm"
  bind:close="onSpecClose"
/>

<!-- è´­ç‰©è½¦å¼¹çª— -->
<cart-popup
  show="{{showCartPopup}}"
  items="{{cartItems}}"
  totalPrice="{{cartTotal}}"
  bind:close="onCartPopupClose"
  bind:change="onCartItemChange"
  bind:clear="onCartClear"
/>

<!-- è´­ç‰©è½¦åº•æ  -->
<view class="cart-bar-wrap">
  <cart-bar
    count="{{cartCount}}"
    totalPrice="{{cartTotal}}"
    merchantId="{{merchantId}}"
    bind:toggle="onCartToggle"
    bind:checkout="onCheckout"
  />
</view>

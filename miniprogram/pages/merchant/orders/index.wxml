<nav-bar title="è®¢å•ç®¡ç†" left-arrow="{{true}}" />

<view class="page-container">
  <!-- Tab bar with badge counts -->
  <view class="tabs-bar">
    <view
      wx:for="{{tabs}}"
      wx:key="key"
      class="tab-item {{activeTab === index ? 'tab-item--active' : ''}}"
      data-index="{{index}}"
      bindtap="onTabTap"
    >
      <text>{{item.label}}</text>
      <view class="tab-badge" wx:if="{{index === 0 && counts.pendingAccept}}">{{counts.pendingAccept}}</view>
      <view class="tab-badge" wx:elif="{{index === 1 && counts.accepted}}">{{counts.accepted}}</view>
      <view class="tab-badge" wx:elif="{{index === 2 && counts.ready}}">{{counts.ready}}</view>
      <view class="tab-underline" wx:if="{{activeTab === index}}"></view>
    </view>
  </view>

  <!-- Notify toggle -->
  <view class="notify-bar" wx:if="{{activeTab === 0}}">
    <text class="notify-text">æ–°è®¢å•æé†’</text>
    <switch checked="{{notifyEnabled}}" color="#FF6B35" bindchange="onToggleNotify" />
  </view>

  <!-- Loading -->
  <view wx:if="{{loading}}" class="loading-center">
    <text>åŠ è½½ä¸­...</text>
  </view>

  <!-- Empty state -->
  <empty-state wx:elif="{{!loading && orders.length === 0}}" icon="order" text="æš‚æ— è®¢å•" />

  <!-- Order list -->
  <view class="order-list" wx:else>
    <view class="order-card" wx:for="{{orders}}" wx:key="_id">
      <!-- Card header -->
      <view class="card-header">
        <view class="card-header-left">
          <text class="order-no">#{{item.order_no}}</text>
          <text class="order-time">{{item._createTime}}</text>
        </view>
        <view class="card-header-right">
          <view wx:if="{{item.status === 'PENDING_ACCEPT'}}" class="countdown {{item._urgent ? 'countdown--urgent' : ''}}">
            <text class="countdown-label">è‡ªåŠ¨å–æ¶ˆ</text>
            <text class="countdown-time">{{item._countdownText}}</text>
          </view>
          <text wx:elif="{{item.status === 'READY'}}" class="ready-time">å‡ºé¤ {{item._readyTime}}</text>
        </view>
      </view>

      <!-- Item list -->
      <view class="card-items">
        <view class="item-row" wx:for="{{item._itemSummary}}" wx:for-item="food" wx:key="name">
          <view class="item-name-wrap">
            <text class="item-name">{{food.name}}</text>
            <text class="item-spec" wx:if="{{food.specStr}}">ï¼ˆ{{food.specStr}}ï¼‰</text>
          </view>
          <text class="item-qty">x{{food.quantity}}</text>
        </view>
      </view>

      <!-- Card footer -->
      <view class="card-footer">
        <view class="card-price">
          <text class="price-label">å®ä»˜</text>
          <text class="price-yen">Â¥</text>
          <price value="{{item.actual_price}}" />
        </view>

        <!-- Action buttons based on status -->
        <view class="card-actions">
          <!-- PENDING_ACCEPT: reject + accept -->
          <block wx:if="{{item.status === 'PENDING_ACCEPT'}}">
            <view class="action-btn action-btn--reject" data-id="{{item._id}}" bindtap="onShowReject">æ‹’å•</view>
            <view class="action-btn action-btn--accept" data-id="{{item._id}}" bindtap="onAccept">æ¥å•</view>
          </block>
          <!-- ACCEPTED: markReady -->
          <block wx:elif="{{item.status === 'ACCEPTED'}}">
            <view class="action-btn action-btn--ready" data-id="{{item._id}}" bindtap="onMarkReady">å‡ºé¤</view>
          </block>
          <!-- READY: complete -->
          <block wx:elif="{{item.status === 'READY'}}">
            <view class="action-btn action-btn--complete" data-id="{{item._id}}" bindtap="onComplete">å®Œæˆ</view>
          </block>
        </view>
      </view>
    </view>

    <!-- Load more -->
    <view class="loading-more" wx:if="{{loadingMore}}">
      <text>åŠ è½½æ›´å¤š...</text>
    </view>
    <view class="no-more" wx:elif="{{!hasMore && orders.length}}">
      <text>æ²¡æœ‰æ›´å¤šäº†</text>
    </view>
  </view>
</view>

<!-- Reject modal -->
<view class="modal-mask" wx:if="{{showRejectModal}}" bindtap="onCancelReject">
  <view class="modal-content" catchtap="">
    <view class="modal-title">æ‹’å•åŸå› </view>
    <view class="reason-list">
      <view
        wx:for="{{rejectReasons}}"
        wx:key="*this"
        class="reason-item {{selectedReason === index ? 'reason-item--selected' : ''}}"
        data-index="{{index}}"
        bindtap="onSelectReason"
      >
        <view class="reason-radio {{selectedReason === index ? 'reason-radio--checked' : ''}}"></view>
        <text>{{item}}</text>
      </view>
    </view>
    <textarea
      wx:if="{{selectedReason === 3}}"
      class="reason-input"
      placeholder="è¯·è¾“å…¥æ‹’å•åŸå› "
      maxlength="100"
      value="{{customReason}}"
      bindinput="onCustomReasonInput"
    />
    <view class="modal-buttons">
      <view class="modal-btn modal-btn--cancel" bindtap="onCancelReject">å–æ¶ˆ</view>
      <view class="modal-btn modal-btn--confirm" bindtap="onConfirmReject">ç¡®è®¤æ‹’å•</view>
    </view>
  </view>
</view>

<!-- New order popup -->
<view class="popup-mask" wx:if="{{showNewOrderPopup}}" bindtap="onDismissPopup">
  <view class="popup-content" catchtap="">
    <view class="popup-icon">ğŸ””</view>
    <view class="popup-title">æ–°è®¢å•æ¥å•¦ï¼</view>
    <view class="popup-summary" wx:if="{{newOrderInfo}}">
      <text>{{newOrderInfo.summary}}</text>
      <text class="popup-price">Â¥<price value="{{newOrderInfo.actualPrice}}" /></text>
    </view>
    <view class="popup-actions">
      <view class="popup-btn popup-btn--dismiss" bindtap="onDismissPopup">çŸ¥é“äº†</view>
      <view class="popup-btn popup-btn--view" bindtap="onViewNewOrder">å»å¤„ç†</view>
    </view>
  </view>
</view>

<nav-bar title="ç¡®è®¤è®¢å•" left-arrow="{{true}}" />

<view class="page-container">
  <block wx:if="{{merchant}}">
    <!-- å–é¤æ–¹å¼ -->
    <view class="section-card">
      <view class="section-title">å–é¤æ–¹å¼</view>
      <view class="delivery-type-tabs">
        <view
          class="delivery-tab {{deliveryType === 'pickup' ? 'delivery-tab--active' : ''}}"
          data-type="pickup"
          bindtap="onDeliveryTypeTap"
        >
          <text>ğŸª åˆ°åº—è‡ªå–</text>
        </view>
        <view
          class="delivery-tab {{deliveryType === 'delivery' ? 'delivery-tab--active' : ''}}"
          data-type="delivery"
          bindtap="onDeliveryTypeTap"
        >
          <text>ğŸ›µ å¤–å–é…é€</text>
        </view>
      </view>

      <!-- è‡ªå–ï¼šæ˜¾ç¤ºå•†å®¶åœ°å€ -->
      <view wx:if="{{deliveryType === 'pickup' && merchant.address}}" class="pickup-address">
        <text class="pickup-icon">ğŸ“</text>
        <text class="address-text">{{merchant.address}}</text>
      </view>

      <!-- é…é€ï¼šæ˜¾ç¤ºæ”¶è´§åœ°å€é€‰æ‹© -->
      <view wx:if="{{deliveryType === 'delivery'}}" class="address-selector" bindtap="onSelectAddress">
        <view wx:if="{{selectedAddress}}" class="address-selected">
          <view class="address-contact">
            <text class="address-name">{{selectedAddress.name}}</text>
            <text class="address-phone">{{selectedAddress.phone}}</text>
          </view>
          <text class="address-detail">{{selectedAddress.address}}{{selectedAddress.detail ? ' ' + selectedAddress.detail : ''}}</text>
        </view>
        <view wx:else class="address-empty">
          <text class="address-empty-icon">ğŸ“</text>
          <text class="address-empty-text">è¯·é€‰æ‹©æ”¶è´§åœ°å€</text>
        </view>
        <text class="address-arrow">></text>
      </view>
    </view>

    <!-- å•†å“æ¸…å• -->
    <view class="section-card">
      <view class="section-title">å•†å“æ¸…å•</view>
      <view class="product-row" wx:for="{{cartItems}}" wx:key="cartId">
        <view class="product-info">
          <text class="product-name">{{item.productName}}</text>
          <text class="product-spec" wx:if="{{item.specText}}"> ({{item.specText}})</text>
        </view>
        <view class="product-right">
          <text class="product-qty">x{{item.quantity}}</text>
          <view class="product-price">
            <price value="{{item.subtotal}}" />
          </view>
        </view>
      </view>
    </view>

    <!-- ä¼˜æƒ åˆ¸/çº¢åŒ… -->
    <view class="section-card coupon-card" bindtap="onCouponTap">
      <view class="coupon-row">
        <text class="coupon-icon">ğŸŸ</text>
        <text class="coupon-label">ä¼˜æƒ åˆ¸/çº¢åŒ…</text>
        <view class="coupon-right">
          <view wx:if="{{selectedCoupon}}">
            <text class="coupon-selected">-Â¥{{selectedCouponAmountLabel}}</text>
            <text class="coupon-name">{{selectedCoupon.name}}</text>
          </view>
          <text wx:else class="coupon-placeholder">ç‚¹å‡»é€‰æ‹©</text>
          <text class="coupon-arrow">></text>
        </view>
      </view>
      <view wx:if="{{selectedCoupon}}" class="coupon-clear" catchtap="onClearCoupon">
        <text>å–æ¶ˆä½¿ç”¨</text>
      </view>
    </view>

    <!-- ä»·æ ¼æ˜ç»† -->
    <view class="section-card">
      <view class="section-title">ä»·æ ¼æ˜ç»†</view>

      <!-- æœªè¾¾èµ·é€ä»·æç¤º -->
      <view wx:if="{{belowMinOrder}}" class="min-order-tip">
        <text>è¿˜å·®Â¥{{minOrderGapLabel}}å…ƒèµ·é€</text>
      </view>

      <view class="price-row">
        <text class="price-label">å•†å“åˆè®¡</text>
        <view class="price-value"><price value="{{totalPrice}}" /></view>
      </view>
      <view class="price-row">
        <text class="price-label">åŒ…è£…è´¹</text>
        <view class="price-value"><price value="{{packingFee}}" /></view>
      </view>
      <view class="price-row" wx:if="{{deliveryType === 'delivery'}}">
        <text class="price-label">é…é€è´¹</text>
        <view class="price-value">
          <text wx:if="{{deliveryFee < 0}}" class="no-delivery">è¶…å‡ºé…é€èŒƒå›´</text>
          <price wx:elif="{{deliveryFee === 0}}" value="0" />
          <price wx:else value="{{deliveryFee}}" />
        </view>
      </view>
      <view class="price-row promo-row" wx:if="{{couponDiscount > 0}}">
        <text class="price-label price-label--discount">ä¼˜æƒ åˆ¸/çº¢åŒ…</text>
        <view class="price-value price-value--discount">
          <text>-Â¥{{couponDiscountLabel}}</text>
        </view>
      </view>
      <view class="price-divider"></view>
      <view class="price-row price-row--total">
        <text class="price-label">åˆè®¡</text>
        <view class="price-value price-value--total"><price value="{{actualPrice}}" /></view>
      </view>
    </view>

    <!-- å¤‡æ³¨ -->
    <view class="section-card">
      <view class="section-title">å¤‡æ³¨</view>
      <textarea
        class="remark-input"
        placeholder="é€‰å¡«ï¼Œå¦‚å£å‘³åå¥½ã€å–é¤æ—¶é—´ç­‰"
        maxlength="200"
        value="{{remark}}"
        bindinput="onRemarkInput"
      />
    </view>
  </block>
</view>

<!-- åº•éƒ¨æäº¤æ  -->
<view class="submit-bar" wx:if="{{merchant}}">
  <view class="submit-total">
    <text class="submit-label">åˆè®¡ </text>
    <view class="submit-price"><price value="{{actualPrice}}" /></view>
  </view>
  <view
    class="submit-btn {{(submitting || belowMinOrder || (deliveryType === 'delivery' && deliveryFee < 0)) ? 'submit-btn--disabled' : ''}}"
    bindtap="onSubmit"
  >
    {{submitting ? 'æäº¤ä¸­...' : belowMinOrder ? 'æœªè¾¾èµ·é€ä»·' : 'æäº¤è®¢å•'}}
  </view>
</view>

<!-- ä¼˜æƒ åˆ¸é€‰æ‹©å¼¹çª— -->
<view wx:if="{{showCouponPicker}}" class="coupon-mask" bindtap="onCloseCouponPicker">
  <view class="coupon-popup" catchtap="">
    <view class="coupon-popup-header">
      <text class="coupon-popup-title">é€‰æ‹©ä¼˜æƒ åˆ¸/çº¢åŒ…</text>
      <text class="coupon-popup-close" bindtap="onCloseCouponPicker">âœ•</text>
    </view>

    <view wx:if="{{availableCoupons.length > 0}}" class="coupon-list">
      <view
        class="coupon-item {{item.is_available ? '' : 'coupon-item--disabled'}}"
        wx:for="{{availableCoupons}}"
        wx:key="_id"
        bindtap="onSelectCoupon"
        data-coupon="{{item}}"
      >
        <view class="coupon-amount-block">
          <text class="coupon-yuan">Â¥</text>
          <text class="coupon-amount">{{item.amountLabel}}</text>
        </view>
        <view class="coupon-detail">
          <text class="coupon-detail-name">{{item.name}}</text>
          <text class="coupon-detail-condition">{{item.conditionLabel}}</text>
          <text class="coupon-detail-expire" wx:if="{{item.expired_at}}">
            æœ‰æ•ˆæœŸè‡³{{item.expired_at}}
          </text>
        </view>
        <view class="coupon-check" wx:if="{{selectedCoupon && selectedCoupon._id === item._id}}">
          <text>âœ“</text>
        </view>
        <view class="coupon-unavail" wx:elif="{{!item.is_available}}">
          <text>ä¸å¯ç”¨</text>
        </view>
      </view>
    </view>

    <view wx:else class="coupon-empty">
      <text class="coupon-empty-text">æš‚æ— å¯ç”¨ä¼˜æƒ åˆ¸</text>
      <text class="coupon-empty-hint">å¯åœ¨ã€Œæˆ‘çš„ã€é¢†å–ä¼˜æƒ åˆ¸</text>
    </view>
  </view>
</view>

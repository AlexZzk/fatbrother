# 胖兄弟外卖小程序 - 产品需求文档（PRD）

> 版本：v1.0.0
> 最后更新：2026-02-10
> 状态：需求评审中

---

## 一、项目概述

### 1.1 项目背景

为摆摊店主提供一站式外卖点餐解决方案。由于目标商户群体多数无营业执照，采用商户自行注册微信商户号 + 平台分账的模式，规避支付牌照问题。

### 1.2 项目目标

- 为C端用户提供类似美团的点餐体验（发现商家 → 浏览菜单 → 下单支付 → 取餐）
- 为B端商户提供轻量级店铺管理工具（菜单管理、订单处理、营业管理）
- 通过推荐裂变机制实现商户增长

### 1.3 技术方案

| 阶段 | 技术栈 | 说明 |
|------|--------|------|
| 一期（当前） | 微信小程序 + 微信云开发 | 快速上线，降低成本 |
| 二期（后续） | 微信小程序 + Java（Spring Boot/Spring Cloud） | 服务迁移，支撑更大规模 |

**关键约束：**
- 仅一个APPID，客户端与管理端在同一小程序内实现
- 所有云函数接口需保留完整接口文档，方便后续迁移至Java后端
- 后续将开发独立的平台管理端（Web端），用于平台运营管理

### 1.4 平台角色

| 角色 | 说明 |
|------|------|
| C端用户 | 普通消费者，浏览商家、点餐下单 |
| B端商户 | 摆摊店主，管理菜单、处理订单 |
| 平台管理员 | 管理商户入驻、查看平台数据（后续Web端实现） |

---

## 二、客户端（C端）需求

### 2.1 用户体系

#### 2.1.1 登录注册

| 项目 | 说明 |
|------|------|
| 登录方式 | 微信授权登录（wx.getUserProfile 获取头像昵称） |
| 手机号 | 非强制。在「个人信息设置」中引导用户授权获取微信绑定手机号 |
| 用户信息 | 微信头像、昵称、手机号（可选）、收货地址（预留） |

#### 2.1.2 收货地址（预留，当前版本不实现）

- 地址管理（增删改查）
- 设置默认地址
- 地图选点定位

### 2.2 首页

#### 2.2.1 页面结构

```
┌─────────────────────────┐
│  📍 当前位置 城市名称     │
├─────────────────────────┤
│  🔍 搜索商家/商品        │
├─────────────────────────┤
│  ┌─────────────────┐    │
│  │   Banner 轮播图   │    │
│  └─────────────────┘    │
├─────────────────────────┤
│  附近商家                │
│  ┌─────────────────────┐│
│  │ 商家头像  商家名称    ││
│  │ ⭐ 4.8  月售120单    ││
│  │ 距离 500m            ││
│  │ 公告: 今日新品xx      ││
│  └─────────────────────┘│
│  ┌─────────────────────┐│
│  │ ...更多商家          ││
│  └─────────────────────┘│
├─────────────────────────┤
│  🏠首页    📋订单   👤我的 │
└─────────────────────────┘
```

#### 2.2.2 功能说明

| 功能 | 说明 |
|------|------|
| 定位 | 获取用户当前定位，展示附近商家 |
| 搜索 | 支持商家名称、商品名称模糊搜索 |
| Banner | 平台运营配置的轮播广告位（预留，一期可写死） |
| 商家列表 | 展示合作商家，按距离排序；只展示营业中的商家 |
| 商家卡片 | 头像、名称、评分、月售数量、距离、公告摘要 |
| 下拉刷新 | 支持下拉刷新商家列表 |
| 上拉加载 | 商家列表分页加载 |

#### 2.2.3 商家距离计算

- 使用腾讯地图/微信内置定位API获取用户经纬度
- 与商家最近一次开店时设置的经纬度计算直线距离
- 距离 < 1km 显示"xxx米"，>= 1km 显示"x.x公里"

### 2.3 商家详情页（点餐页）

#### 2.3.1 页面结构

```
┌─────────────────────────┐
│  ← 返回    商家名称       │
├─────────────────────────┤
│  商家头图/头像            │
│  商家名称  ⭐4.8         │
│  📍 距离500m             │
│  📢 公告: 今日新品xx      │
├─────────────────────────┤
│  分类1  │  商品A   ¥12   │
│  分类2  │  商品B   ¥15   │
│  分类3  │  [+] 选规格     │
│         │  商品C   ¥8    │
│         │  [+]           │
├─────────────────────────┤
│  🛒 购物车  ¥35  去结算   │
└─────────────────────────┘
```

#### 2.3.2 功能说明

| 功能 | 说明 |
|------|------|
| 商家信息 | 展示商家头图、名称、评分、距离、公告 |
| 菜单分类 | 左侧分类导航，右侧商品列表，联动滚动 |
| 商品卡片 | 商品图片（可选展示）、名称、描述、价格、加入购物车按钮 |
| 规格选择 | 点击"+"弹出规格选择弹窗（详见2.4） |
| 购物车 | 底部悬浮购物车栏，展示总价和商品数量 |
| 购物车独立 | 每个商家的购物车相互独立 |

### 2.4 商品规格与加料系统

这是本项目中较复杂的模块，需要支持灵活的商品自定义配置。

#### 2.4.1 数据模型设计

```
商品 (Product)
├── 规格组 (SpecGroup)  -- 如"杯型"、"辣度"
│   ├── 必选/可选标识
│   ├── 单选/多选标识
│   └── 规格项 (SpecItem)  -- 如"大杯+3元"、"中杯+0元"、"小杯-2元"
│       ├── 名称
│       └── 加价（可为负数，表示减价）
└── 加料组 (ExtraGroup)  -- 如"加料"
    ├── 可多选
    └── 加料项 (ExtraItem)  -- 如"加珍珠+1元"、"加椰果+2元"
        ├── 名称
        └── 加价
```

#### 2.4.2 规格组类型说明

| 类型 | 是否必选 | 是否多选 | 示例 |
|------|---------|---------|------|
| 必选单选 | 是 | 否 | 杯型（大/中/小）、辣度（微辣/中辣/特辣） |
| 必选多选 | 是 | 是 | 预留（如必选2种配菜） |
| 可选单选 | 否 | 否 | 是否打包（打包+1元） |
| 可选多选 | 否 | 是 | 加料（珍珠、椰果、布丁...） |

#### 2.4.3 规格选择弹窗交互

```
┌─────────────────────────┐
│  商品名称        ¥12起   │
├─────────────────────────┤
│  杯型（必选）             │
│  [大杯+3] [中杯] [小杯-2]│
├─────────────────────────┤
│  辣度（必选）             │
│  [微辣] [中辣] [特辣]    │
├─────────────────────────┤
│  加料（可选，可多选）      │
│  [珍珠+1] [椰果+2]      │
├─────────────────────────┤
│  不要/备注（可选，可多选） │
│  [不要葱] [不要蒜] [不要香菜] │
├─────────────────────────┤
│  数量   [-] 1 [+]       │
├─────────────────────────┤
│  加入购物车    ¥15       │
└─────────────────────────┘
```

- 最终价格 = 商品基础价 + 各规格加价 + 各加料加价
- 必选规格未选择时，"加入购物车"按钮置灰不可点击
- 同一商品不同规格组合在购物车中作为独立条目

### 2.5 购物车

#### 2.5.1 功能说明

| 功能 | 说明 |
|------|------|
| 展开收起 | 点击底部购物车栏可展开购物车详情 |
| 商品列表 | 展示已选商品名称、规格摘要、单价、数量 |
| 数量调整 | 支持增减数量，减到0时移除该条目 |
| 清空 | 一键清空购物车 |
| 总价计算 | 实时计算总价 |
| 去结算 | 跳转到订单确认页 |

#### 2.5.2 购物车数据存储

- 购物车数据存储在本地（Storage），不持久化到云端
- 按商家ID隔离，切换商家时切换购物车
- 小程序关闭后购物车数据保留（Storage持久化）

### 2.6 订单确认页

```
┌─────────────────────────┐
│  ← 确认订单              │
├─────────────────────────┤
│  取餐方式: 到店自取       │
│  📍 商家地址/定位         │
├─────────────────────────┤
│  商品列表                │
│  奶茶(大杯+珍珠) x1  ¥16│
│  炒饭(中辣)      x2  ¥30│
├─────────────────────────┤
│  商品合计          ¥46   │
│  包装费            ¥0    │  ← 预留字段
│  配送费            ¥0    │  ← 预留字段
├─────────────────────────┤
│  备注: 请在xx点前做好      │
├─────────────────────────┤
│  提交订单         ¥46    │
└─────────────────────────┘
```

### 2.7 订单流程

#### 2.7.1 订单状态流转

```
用户下单并支付
    │
    ▼
[待接单] ──超时30分钟──→ [已取消] → 自动退款
    │
    ├──商家拒绝接单──→ [已取消] → 自动退款
    │
    ▼
[已接单/制作中]
    │
    ▼
[待取餐] ──用户确认取餐──→ [已完成]
    │
    │  （后续扩展）
    ▼
[配送中] → [已送达] → [已完成]
```

#### 2.7.2 订单状态说明

| 状态 | 状态码 | C端展示 | B端操作 |
|------|--------|---------|---------|
| 待支付 | PENDING_PAY | 等待支付（预留，当前下单即支付） | - |
| 待接单 | PENDING_ACCEPT | 商家确认中 | 接单 / 拒单 |
| 已接单 | ACCEPTED | 商家正在制作 | 标记出餐 |
| 待取餐 | READY | 请前往取餐 | 等待用户取餐 |
| 配送中 | DELIVERING | 骑手配送中（预留） | - |
| 已完成 | COMPLETED | 已完成 | - |
| 已取消 | CANCELLED | 已取消 | - |
| 退款中 | REFUNDING | 退款中 | - |
| 已退款 | REFUNDED | 已退款 | - |

#### 2.7.3 退款规则

| 场景 | 处理方式 |
|------|---------|
| 商家拒绝接单 | 系统自动退款 |
| 超时未接单（30分钟） | 系统自动取消并退款 |
| 用户主动取消（待接单状态） | 直接取消并退款 |
| 用户主动取消（已接单状态） | 需商家同意后退款 |
| 用户主动取消（待取餐状态） | 不允许取消，需联系商家协商 |

### 2.8 订单列表页

#### 2.8.1 功能说明

| 功能 | 说明 |
|------|------|
| 订单列表 | 按时间倒序展示所有订单 |
| 订单筛选 | 全部 / 待接单 / 制作中 / 待取餐 / 已完成 |
| 订单卡片 | 商家名称、商品摘要、总价、订单状态、下单时间 |
| 订单详情 | 点击进入订单详情页 |
| 再来一单 | 已完成订单支持"再来一单" |
| 评价入口 | 已完成订单支持"去评价" |

### 2.9 评价系统

#### 2.9.1 功能说明

| 功能 | 说明 |
|------|------|
| 评价时机 | 订单完成后可评价 |
| 评分维度 | 综合评分（1-5星） |
| 评价内容 | 文字评价（可选） |
| 评价展示 | 在商家详情页展示评价列表和平均评分 |
| 评价限制 | 每个订单只能评价一次 |

### 2.10 "我的"页面

```
┌─────────────────────────┐
│  用户头像  用户昵称       │
│  手机号: 未绑定 > 去绑定  │
├─────────────────────────┤
│  📋 我的订单         >   │
│  📊 账单统计         >   │
│  📍 收货地址（预留）  >   │
│  ⚙️  设置            >   │
├─────────────────────────┤
│  🏪 商户管理         >   │  ← 商户入口（见3.1）
├─────────────────────────┤
│  📞 联系客服         >   │
│  ℹ️  关于我们         >   │
└─────────────────────────┘
```

#### 2.10.1 账单统计

| 功能 | 说明 |
|------|------|
| 统计维度 | 按月统计消费金额 |
| 展示内容 | 本月消费、订单数、平均单价 |
| 消费记录 | 按时间倒序展示消费流水 |

### 2.11 消息通知（微信订阅消息）

| 通知场景 | 接收方 | 通知内容 |
|---------|-------|---------|
| 下单成功 | 用户 | 订单已提交，等待商家接单 |
| 商家接单 | 用户 | 商家已接单，正在制作 |
| 出餐通知 | 用户 | 您的餐品已备好，请前往取餐 |
| 订单取消 | 用户 | 订单已取消（含原因） |
| 退款通知 | 用户 | 退款已发起/退款到账 |
| 新订单提醒 | 商户 | 您有新的订单，请及时处理 |
| 订单即将超时 | 商户 | 订单即将超时（接单前25分钟提醒） |

---

## 三、管理端（B端）需求

### 3.1 商户入口与身份验证

#### 3.1.1 入口设计

- 在C端"我的"页面设置"商户管理"入口
- 点击后判断当前微信用户是否绑定了商户身份：
  - **已绑定**：直接进入商户管理后台
  - **未绑定**：展示商户入驻引导页

#### 3.1.2 商户入驻流程

```
用户点击"商户管理"
    │
    ▼
展示入驻引导页
    │
    ▼
输入邀请码（由平台或推荐商户提供）
    │
    ▼
填写基本信息
  - 店铺名称
  - 联系人姓名
  - 联系电话
  - 微信商户号ID（MCH_ID）
    │
    ▼
提交申请 → 等待平台审核
    │
    ▼
平台审核通过 → 商户身份激活
    │
    ▼
进入商户管理后台
```

**邀请码机制：**
- 每个已入驻商户自动生成一个专属邀请码
- 平台管理员也可手动生成邀请码
- 邀请码用于追踪推荐关系链

#### 3.1.3 商户权限控制

| 权限 | 说明 |
|------|------|
| 店铺拥有者 | 最高权限，管理所有功能 |
| 店员（预留） | 可处理订单，不可修改店铺信息和菜单 |

- 一期仅支持一个管理员（店铺拥有者）
- 数据模型预留店员角色，支持后续扩展

### 3.2 商户后台首页（数据看板）

```
┌─────────────────────────┐
│  ← 胖兄弟商户后台        │
├─────────────────────────┤
│  当前状态: 🟢 营业中      │
│  [结束营业]              │
├─────────────────────────┤
│  今日数据                │
│  ┌──────┬──────┬──────┐ │
│  │订单数 │营业额 │ 退款  │ │
│  │  12  │ ¥358 │  ¥0  │ │
│  └──────┴──────┴──────┘ │
├─────────────────────────┤
│  待处理订单 (3)      >   │
├─────────────────────────┤
│  快捷入口                │
│  [菜单管理] [订单管理]    │
│  [账单统计] [店铺设置]    │
└─────────────────────────┘
```

### 3.3 营业状态管理

#### 3.3.1 开店/闭店

| 功能 | 说明 |
|------|------|
| 开始营业 | 商家主动点击开始营业，更新店铺状态为营业中 |
| 更新定位 | 每次开始营业时，获取当前GPS定位作为店铺位置 |
| 结束营业 | 商家主动点击结束营业，C端不再展示该商家 |
| 状态展示 | 首页顶部醒目展示当前营业状态 |

#### 3.3.2 规则

- 闭店状态下，C端用户搜索不到该商家
- 闭店状态下，已有的未完成订单仍需正常处理
- 开店时需授权定位权限

### 3.4 菜单管理

#### 3.4.1 分类管理

| 功能 | 说明 |
|------|------|
| 新增分类 | 输入分类名称，如"热销"、"主食"、"饮品" |
| 编辑分类 | 修改分类名称 |
| 删除分类 | 删除分类（分类下有商品时需先移除） |
| 排序 | 支持分类拖拽排序 |

#### 3.4.2 商品管理

| 功能 | 说明 |
|------|------|
| 新增商品 | 填写商品信息并归属到某个分类 |
| 编辑商品 | 修改商品信息 |
| 删除商品 | 删除商品 |
| 上下架 | 切换商品售卖状态（售罄/上架） |
| 排序 | 支持同分类内商品排序 |

**商品信息字段：**

| 字段 | 必填 | 说明 |
|------|------|------|
| 商品名称 | 是 | 最多30字 |
| 商品图片 | 否 | 建议尺寸，最多1张 |
| 商品描述 | 否 | 简短描述，最多100字 |
| 基础价格 | 是 | 单位：元，精确到分 |
| 所属分类 | 是 | 选择已有分类 |
| 排序权重 | 否 | 默认0，数值越大越靠前 |

#### 3.4.3 规格/加料配置（重点模块）

商户端需要提供直观的规格配置界面：

**配置流程：**

```
编辑商品 → 添加规格组
              │
              ├── 规格组名称（如"杯型"）
              ├── 是否必选（开关）
              ├── 单选/多选（开关）
              └── 添加选项
                    ├── 选项名称（如"大杯"）
                    └── 加价金额（如+3元）

编辑商品 → 添加规格组
              │
              ├── 规格组名称（如"加料"）
              ├── 是否必选（否）
              ├── 单选/多选（多选）
              └── 添加选项
                    ├── 珍珠 +1元
                    ├── 椰果 +2元
                    └── 布丁 +1.5元
```

**交互设计要点：**
- 每个商品可添加多个规格组
- 每个规格组可添加多个选项
- 选项支持设置加价金额（0表示不加价，支持负数表示减价）
- 提供常用规格模板快速填充（如"杯型"、"辣度"、"甜度"、"温度"）
- 支持将当前商品的规格配置复制到其他商品

### 3.5 订单管理

#### 3.5.1 订单列表

| 功能 | 说明 |
|------|------|
| 订单筛选 | 全部 / 待接单 / 制作中 / 待取餐 / 已完成 / 已取消 |
| 新订单提醒 | 新订单到达时声音+振动提醒 |
| 订单卡片 | 订单号、用户信息、商品明细、总价、下单时间 |
| 倒计时 | 待接单状态展示剩余接单时间倒计时 |

#### 3.5.2 订单操作

| 当前状态 | 可执行操作 | 操作结果 |
|---------|-----------|---------|
| 待接单 | 接单 | 状态变为"已接单/制作中" |
| 待接单 | 拒单（需填写原因） | 状态变为"已取消"，触发自动退款 |
| 已接单 | 标记出餐 | 状态变为"待取餐" |
| 已接单 | 取消订单（需填写原因） | 状态变为"已取消"，触发退款 |
| 待取餐 | 确认完成 | 状态变为"已完成" |

#### 3.5.3 新订单提醒机制

- 商家进入管理后台时，建立轮询（一期用定时拉取，后续可升级为WebSocket）
- 新订单到达时：
  - 播放提示音（可在设置中关闭）
  - 手机振动
  - 弹出新订单弹窗提示
- 轮询间隔：10秒

### 3.6 账单统计

| 功能 | 说明 |
|------|------|
| 今日统计 | 订单数、营业额、退款金额 |
| 历史统计 | 按日/周/月查看营业数据 |
| 账单明细 | 每笔订单的收入明细 |
| 平台抽佣 | 展示平台抽佣金额（商户可见自己被扣了多少） |

### 3.7 店铺设置

| 功能 | 说明 |
|------|------|
| 店铺名称 | 修改店铺名称 |
| 店铺头图 | 上传/修改店铺头图 |
| 店铺公告 | 编辑公告内容，最多200字 |
| 联系电话 | 修改联系电话 |
| 我的邀请码 | 展示专属邀请码，支持分享 |
| 起送价 | 预留，当前版本不实现 |
| 包装费 | 预留，当前版本不实现 |
| 配送费 | 预留，当前版本不实现 |

---

## 四、支付与分账系统

### 4.1 支付流程

```
用户提交订单
    │
    ▼
调用微信支付（分账模式）
  - 收款方：商户的微信商户号
  - 分账标记：标记为需要分账的订单
    │
    ▼
支付成功 → 创建订单 → 通知商户
    │
    ▼
订单完成后触发分账
  - 平台抽佣比例：固定值（如10%）
  - 调用微信分账接口，将抽佣部分分给平台
```

### 4.2 分账模式说明

| 项目 | 说明 |
|------|------|
| 交易主体 | 商户微信商户号 |
| 支付方式 | 微信支付（JSAPI） |
| 分账接收方 | 平台方微信商户号 |
| 分账触发时机 | 订单状态变为"已完成" |
| 分账比例 | 固定比例，由平台设定（如10%） |

### 4.3 退款处理

| 场景 | 退款来源 |
|------|---------|
| 未分账订单退款 | 直接从商户账户退款 |
| 已分账订单退款 | 需先撤销分账，再退款 |

---

## 五、推荐裂变系统

### 5.1 机制概述

通过商户推荐商户的方式实现增长，推荐人可从被推荐商户的平台抽佣中获得分成。

### 5.2 推荐层级

最多支持 **2级推荐人**（加上平台共3方分配）。

### 5.3 分成规则

> 假设平台抽佣比例为 10%，以下用具体数字说明：

**场景一：商户A（无推荐人，直接入驻）**

```
商户A的订单抽佣 10%
  └── 100% → 平台
```

**场景二：商户A推荐了商户B**

```
商户B的订单抽佣 10%
  ├── 50% → 商户A（推荐人）
  └── 50% → 平台
```

**场景三：商户B又推荐了商户C**

```
商户C的订单抽佣 10%
  ├── 50% → 商户B（直接推荐人）
  │    └── 100% 归商户B
  └── 50% → 商户A（间接推荐人）
       ├── 50% → 商户A
       └── 50% → 平台

即：商户C的抽佣分配：
  - 商户B：50%
  - 商户A：25%
  - 平台：25%
```

**场景四：商户C又推荐了商户D（超出2级，截断）**

```
商户D的订单抽佣 10%
  ├── 50% → 商户C（直接推荐人）
  └── 50% → 商户B（间接推荐人，即商户C的推荐人）
       ├── 50% → 商户B
       └── 50% → 平台

推荐链：A → B → C → D
商户D的分成只追溯到 C 和 B（2级），A 不再参与。

即：商户D的抽佣分配：
  - 商户C：50%
  - 商户B：25%
  - 平台：25%
```

### 5.4 邀请码机制

| 功能 | 说明 |
|------|------|
| 生成规则 | 商户入驻成功后自动生成唯一邀请码 |
| 邀请码格式 | 6位字母数字组合，如 `A3X9K2` |
| 分享方式 | 商户可在"店铺设置"中查看并分享邀请码 |
| 绑定关系 | 新商户注册时输入邀请码，永久绑定推荐关系 |
| 关系链存储 | 每个商户记录直接推荐人ID和间接推荐人ID |

---

## 六、数据模型设计（概要）

### 6.1 核心数据表

#### 用户表 (users)

| 字段 | 类型 | 说明 |
|------|------|------|
| _id | string | 用户ID（云开发自动生成） |
| openid | string | 微信openid |
| unionid | string | 微信unionid（预留） |
| nickname | string | 昵称 |
| avatar_url | string | 头像URL |
| phone | string | 手机号（可选） |
| role | string | 角色：user / merchant |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

#### 商户表 (merchants)

| 字段 | 类型 | 说明 |
|------|------|------|
| _id | string | 商户ID |
| user_id | string | 关联用户ID |
| mch_id | string | 微信商户号ID |
| shop_name | string | 店铺名称 |
| shop_avatar | string | 店铺头图URL |
| announcement | string | 店铺公告 |
| contact_name | string | 联系人姓名 |
| contact_phone | string | 联系电话 |
| status | string | 状态：pending/active/disabled |
| is_open | boolean | 是否营业中 |
| location | geopoint | 最新店铺定位 |
| invite_code | string | 专属邀请码 |
| referrer_id | string | 直接推荐人商户ID |
| indirect_referrer_id | string | 间接推荐人商户ID |
| rating | number | 综合评分 |
| monthly_sales | number | 月售数量 |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

#### 商品分类表 (categories)

| 字段 | 类型 | 说明 |
|------|------|------|
| _id | string | 分类ID |
| merchant_id | string | 所属商户ID |
| name | string | 分类名称 |
| sort_order | number | 排序权重 |
| created_at | timestamp | 创建时间 |

#### 商品表 (products)

| 字段 | 类型 | 说明 |
|------|------|------|
| _id | string | 商品ID |
| merchant_id | string | 所属商户ID |
| category_id | string | 所属分类ID |
| name | string | 商品名称 |
| image | string | 商品图片URL |
| description | string | 商品描述 |
| base_price | number | 基础价格（分） |
| spec_groups | array | 规格组数组（嵌套文档，见下方） |
| is_on_sale | boolean | 是否上架 |
| sort_order | number | 排序权重 |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

**spec_groups 嵌套结构：**

```json
{
  "spec_groups": [
    {
      "id": "sg_001",
      "name": "杯型",
      "required": true,
      "multi_select": false,
      "items": [
        { "id": "si_001", "name": "大杯", "price_delta": 300 },
        { "id": "si_002", "name": "中杯", "price_delta": 0 },
        { "id": "si_003", "name": "小杯", "price_delta": -200 }
      ]
    },
    {
      "id": "sg_002",
      "name": "加料",
      "required": false,
      "multi_select": true,
      "items": [
        { "id": "si_004", "name": "珍珠", "price_delta": 100 },
        { "id": "si_005", "name": "椰果", "price_delta": 200 }
      ]
    }
  ]
}
```

> 注：价格统一使用 **分** 为单位，避免浮点精度问题。

#### 订单表 (orders)

| 字段 | 类型 | 说明 |
|------|------|------|
| _id | string | 订单ID |
| order_no | string | 订单编号（展示用） |
| user_id | string | 下单用户ID |
| merchant_id | string | 商户ID |
| items | array | 订单商品明细（快照） |
| total_price | number | 商品总价（分） |
| packing_fee | number | 包装费（分），预留 |
| delivery_fee | number | 配送费（分），预留 |
| actual_price | number | 实付金额（分） |
| status | string | 订单状态（见2.7.2） |
| remark | string | 订单备注 |
| cancel_reason | string | 取消原因 |
| payment_id | string | 微信支付单号 |
| paid_at | timestamp | 支付时间 |
| accepted_at | timestamp | 接单时间 |
| ready_at | timestamp | 出餐时间 |
| completed_at | timestamp | 完成时间 |
| cancelled_at | timestamp | 取消时间 |
| is_settled | boolean | 是否已分账 |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

**items 嵌套结构（商品快照）：**

```json
{
  "items": [
    {
      "product_id": "p_001",
      "product_name": "珍珠奶茶",
      "base_price": 1200,
      "specs": [
        { "group_name": "杯型", "item_name": "大杯", "price_delta": 300 },
        { "group_name": "加料", "item_name": "珍珠", "price_delta": 100 }
      ],
      "quantity": 1,
      "subtotal": 1600
    }
  ]
}
```

#### 评价表 (reviews)

| 字段 | 类型 | 说明 |
|------|------|------|
| _id | string | 评价ID |
| order_id | string | 关联订单ID |
| user_id | string | 用户ID |
| merchant_id | string | 商户ID |
| rating | number | 评分（1-5） |
| content | string | 评价内容 |
| created_at | timestamp | 评价时间 |

#### 分账记录表 (settlements)

| 字段 | 类型 | 说明 |
|------|------|------|
| _id | string | 记录ID |
| order_id | string | 关联订单ID |
| merchant_id | string | 商户ID |
| order_amount | number | 订单金额（分） |
| commission_rate | number | 抽佣比例（如0.10） |
| commission_amount | number | 抽佣总额（分） |
| platform_amount | number | 平台分得（分） |
| referrer_amount | number | 直接推荐人分得（分） |
| indirect_referrer_amount | number | 间接推荐人分得（分） |
| status | string | 状态：pending/completed/reversed |
| created_at | timestamp | 创建时间 |

---

## 七、非功能需求

### 7.1 性能要求

| 指标 | 目标 |
|------|------|
| 首页加载 | < 2秒 |
| 接口响应 | < 1秒 |
| 商家列表 | 分页加载，每页20条 |

### 7.2 安全要求

| 项目 | 说明 |
|------|------|
| 数据权限 | 商户只能查看/操作自己店铺的数据 |
| 支付安全 | 所有金额在服务端计算，客户端传参仅作展示 |
| 接口鉴权 | 云函数中验证用户身份和权限 |

### 7.3 兼容性

| 项目 | 说明 |
|------|------|
| 微信版本 | 基础库 >= 2.25.0 |
| 设备 | iOS / Android 均需适配 |

---

## 八、版本规划

### V1.0（一期 - MVP）

**目标：跑通核心流程**

| 模块 | 功能 |
|------|------|
| C端 | 微信登录、首页商家列表、商家详情点餐、规格选择、购物车、下单支付、订单列表、订单详情 |
| B端 | 商户入驻（邀请码）、菜单管理（含分类、规格配置）、订单管理（接单/拒单/出餐）、营业状态切换、数据看板 |
| 支付 | 微信支付分账模式对接 |
| 通知 | 订阅消息（订单状态通知） |

### V1.1（二期）

| 模块 | 功能 |
|------|------|
| C端 | 手机号绑定、评价系统、搜索功能完善、账单统计 |
| B端 | 账单统计完善、推荐裂变分成报表、店铺设置完善 |
| 平台 | 推荐裂变分账对接 |

### V1.2（三期）

| 模块 | 功能 |
|------|------|
| C端 | 收货地址管理、配送费/包装费/起送价 |
| B端 | 蓝牙打印小票、营业时间设置、多员工管理 |
| 平台 | Web管理后台（商户管理、数据统计） |

### V2.0（四期）

| 模块 | 功能 |
|------|------|
| 整体 | 迁移至Java后端（Spring Boot/Spring Cloud） |
| C端 | 骑手配送流程、实时配送追踪 |
| 骑手端 | 骑手小程序或H5 |

---

## 九、开放问题（待后续确认）

| 编号 | 问题 | 影响模块 |
|------|------|---------|
| Q1 | 推荐裂变超过2级后的精确分成规则需最终确认 | 分账系统 |
| Q2 | 平台抽佣具体比例（暂定10%）需最终确认 | 分账系统 |
| Q3 | 邀请码是否支持平台手动发放（非商户推荐场景） | 商户入驻 |
| Q4 | 商家拒单后是否需要上报平台（恶意拒单监控） | 订单系统 |
| Q5 | 用户取消订单是否有次数限制（防恶意下单） | 订单系统 |
